<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioRemix Studio - Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using stable, compatible versions -->
    <script src="https://unpkg.com/wavesurfer.js@7.0.0/dist/wavesurfer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        /* Custom Range Inputs */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]:focus { outline: none; }
        
        /* Horizontal Slider Thumb */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #e879f9;
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 0 10px rgba(232, 121, 249, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4c1d95;
            border-radius: 2px;
        }

        /* Vertical EQ Sliders */
        .slider-v {
            writing-mode: bt-lr; /* IE/Edge */
            -webkit-appearance: slider-vertical; /* Webkit */
            width: 8px;
            height: 100px;
            background: transparent;
            cursor: pointer;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f0720; }
        ::-webkit-scrollbar-thumb { background: #581c87; border-radius: 3px; }

        .glass {
            background: rgba(19, 11, 41, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body class="bg-[#05030a] text-white h-screen flex flex-col overflow-hidden font-sans">

    <!-- Header -->
    <header class="h-16 border-b border-purple-900/30 flex items-center justify-between px-6 bg-[#0f0720] z-20 shrink-0">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 text-xl font-bold tracking-tight">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>
                </div>
                AudioRemix
            </div>
            
            <div class="h-8 w-[1px] bg-gray-800 mx-2"></div>

            <label class="cursor-pointer bg-purple-700 hover:bg-purple-600 text-white px-4 py-1.5 rounded-md text-sm font-medium transition flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                Upload File
                <input type="file" id="fileInput" accept="audio/*" class="hidden">
            </label>
            
            <div class="flex flex-col justify-center">
                <span id="fileName" class="text-xs text-gray-300 font-mono max-w-[200px] truncate">No file loaded</span>
                <span id="statusText" class="text-[10px] text-gray-500">Idle</span>
            </div>
        </div>

        <div class="flex gap-3">
            <button id="resetBtn" class="px-4 py-1.5 text-xs font-bold text-gray-400 hover:text-white border border-gray-800 rounded hover:bg-gray-800 transition">RESET</button>
            <button id="downloadBtn" class="bg-white text-black px-4 py-1.5 rounded text-xs font-bold hover:bg-gray-200 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                DOWNLOAD WAV
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left: Visualizer & Player -->
        <div class="flex-1 flex flex-col bg-gradient-to-b from-[#0f0720] to-[#05030a] relative">
            
            <!-- Waveform Container -->
            <div class="flex-1 flex items-center justify-center px-4 relative">
                <div id="waveform" class="w-full h-64"></div>
                
                <!-- Loading / Error Overlay -->
                <div id="overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-[#05030a]/80 z-10 hidden backdrop-blur-sm">
                    <div id="spinner" class="w-10 h-10 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mb-3"></div>
                    <p id="overlayText" class="text-purple-300 font-mono text-sm">Processing...</p>
                </div>
            </div>

            <!-- Transport Controls -->
            <div class="h-20 border-t border-purple-900/20 bg-[#0a0514] flex items-center justify-between px-8 shrink-0">
                <div class="flex items-center gap-4">
                    <button id="playBtn" class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-black hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg id="playIcon" class="w-5 h-5 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <div class="font-mono text-sm">
                        <span id="currentTime" class="text-white font-bold">0:00</span>
                        <span id="totalTime" class="text-gray-600"> / 0:00</span>
                    </div>
                </div>
                
                <!-- Console Log -->
                <div id="consoleLog" class="text-[10px] font-mono text-green-500/70 max-w-md truncate hidden md:block">
                    > System Ready.
                </div>
            </div>
        </div>

        <!-- Right: Controls Sidebar -->
        <div class="w-80 lg:w-96 bg-[#0a0514] border-l border-purple-900/20 flex flex-col overflow-y-auto custom-scrollbar shrink-0">
            
            <!-- Presets -->
            <div class="p-5 border-b border-white/5">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Quick Presets</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="applyPreset('slowed')" class="py-2 bg-purple-900/20 border border-purple-800/50 rounded hover:bg-purple-800/40 text-xs text-purple-200 transition">Slowed + Reverb</button>
                    <button onclick="applyPreset('nightcore')" class="py-2 bg-purple-900/20 border border-purple-800/50 rounded hover:bg-purple-800/40 text-xs text-purple-200 transition">Nightcore</button>
                </div>
            </div>

            <!-- Effects -->
            <div class="p-5 space-y-6">
                
                <!-- Speed -->
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-medium text-gray-400">Speed</label>
                        <span id="speedVal" class="text-[10px] bg-purple-900 px-1.5 py-0.5 rounded text-purple-200">1.00x</span>
                    </div>
                    <input type="range" id="speedRange" min="0.5" max="1.5" step="0.01" value="1">
                </div>

                <!-- Pitch -->
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-medium text-gray-400">Pitch Shift</label>
                        <span id="pitchVal" class="text-[10px] bg-purple-900 px-1.5 py-0.5 rounded text-purple-200">0 semi</span>
                    </div>
                    <input type="range" id="pitchRange" min="-12" max="12" step="1" value="0">
                </div>

                <!-- Reverb -->
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-medium text-gray-400">Reverb</label>
                        <span id="reverbVal" class="text-[10px] bg-purple-900 px-1.5 py-0.5 rounded text-purple-200">0%</span>
                    </div>
                    <input type="range" id="reverbRange" min="0" max="0.8" step="0.01" value="0">
                </div>

                <!-- Bass -->
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-medium text-gray-400">Bass Boost</label>
                        <span id="bassVal" class="text-[10px] bg-purple-900 px-1.5 py-0.5 rounded text-purple-200">0 dB</span>
                    </div>
                    <input type="range" id="bassRange" min="0" max="20" step="1" value="0">
                </div>
            </div>

            <!-- EQ -->
            <div class="flex-1 p-5 bg-[#05030a] border-t border-white/5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Equalizer</h3>
                    <button onclick="resetEQ()" class="text-[10px] text-purple-400 hover:text-white">Flat</button>
                </div>
                <div class="flex justify-between h-32 items-end px-1">
                    <!-- EQ Sliders generated by JS -->
                    <div class="flex flex-col items-center gap-1 h-full"><input type="range" class="slider-v eq-band" data-idx="0" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">60</span></div>
                    <div class="flex flex-col items-center gap-1 h-full"><input type="range" class="slider-v eq-band" data-idx="1" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">150</span></div>
                    <div class="flex flex-col items-center gap-1 h-full"><input type="range" class="slider-v eq-band" data-idx="2" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">400</span></div>
                    <div class="flex flex-col items-center gap-1 h-full"><input type="range" class="slider-v eq-band" data-idx="3" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">1k</span></div>
                    <div class="flex flex-col items-center gap-1 h-full"><input type="range" class="slider-v eq-band" data-idx="4" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">2.5k</span></div>
                    <div class="flex flex-col items-center gap-1 h-full"><input type="range" class="slider-v eq-band" data-idx="5" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">6k</span></div>
                    <div class="flex flex-col items-center gap-1 h-full"><input type="range" class="slider-v eq-band" data-idx="6" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">14k</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Progress Modal -->
    <div id="dlModal" class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col items-center justify-center">
        <div class="w-64">
            <div class="flex justify-between text-xs text-purple-300 mb-1">
                <span>Rendering...</span>
                <span id="dlPercent">0%</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-1.5">
                <div id="dlBar" class="bg-purple-500 h-1.5 rounded-full transition-all duration-100" style="width: 0%"></div>
            </div>
        </div>
        <p class="text-gray-500 text-xs mt-4">Please wait while we process your audio.</p>
    </div>

    <script>
        // --- Global Variables ---
        let wavesurfer;
        let tonePlayer;
        let audioBuffer = null;
        let isPlaying = false;
        
        // Audio Nodes
        let pitchShift, reverb, bassBoost, limiter;
        let eqNodes = [];
        const eqFreqs = [60, 150, 400, 1000, 2500, 6000, 14000];

        // DOM Elements
        const els = {
            fileInput: document.getElementById('fileInput'),
            playBtn: document.getElementById('playBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            fileName: document.getElementById('fileName'),
            status: document.getElementById('statusText'),
            console: document.getElementById('consoleLog'),
            overlay: document.getElementById('overlay'),
            overlayText: document.getElementById('overlayText'),
            spinner: document.getElementById('spinner'),
            playIcon: document.getElementById('playIcon'),
            pauseIcon: document.getElementById('pauseIcon'),
            currentTime: document.getElementById('currentTime'),
            totalTime: document.getElementById('totalTime')
        };

        // --- Logging Helper ---
        function log(msg, isError = false) {
            els.console.innerText = `> ${msg}`;
            els.status.innerText = msg;
            if(isError) {
                els.console.style.color = '#ef4444'; // Red
                console.error(msg);
            } else {
                els.console.style.color = '#22c55e'; // Green
            }
        }

        function showLoader(msg) {
            els.overlay.classList.remove('hidden');
            els.overlayText.innerText = msg;
            els.spinner.classList.remove('hidden');
        }

        function hideLoader() {
            els.overlay.classList.add('hidden');
        }

        function showError(msg) {
            els.overlay.classList.remove('hidden');
            els.overlayText.innerText = msg;
            els.overlayText.classList.add('text-red-400');
            els.spinner.classList.add('hidden');
            log(msg, true);
        }

        // --- Initialization ---
        async function init() {
            try {
                // 1. Setup WaveSurfer (Visuals Only)
                wavesurfer = WaveSurfer.create({
                    container: '#waveform',
                    waveColor: '#4c1d95',
                    progressColor: '#a855f7',
                    cursorColor: '#fff',
                    barWidth: 3,
                    barGap: 3,
                    barRadius: 3,
                    height: 200,
                    normalize: true,
                    interact: true,
                });

                // 2. Setup Tone.js Context (Audio Processing)
                // We don't start it yet, waiting for user interaction
                
                // 3. Setup Effects Chain
                pitchShift = new Tone.PitchShift({ pitch: 0 }).toDestination();
                reverb = new Tone.Reverb({ decay: 2.0, preDelay: 0.1 }).toDestination();
                reverb.wet.value = 0;
                bassBoost = new Tone.Filter(200, "lowshelf").toDestination();
                limiter = new Tone.Limiter(-1).toDestination();

                // Create EQ Nodes
                eqNodes = eqFreqs.map(f => {
                    const filter = new Tone.Filter(f, "peaking");
                    filter.Q.value = 1;
                    filter.gain.value = 0;
                    return filter;
                });

                log("System Initialized. Waiting for file.");

            } catch (e) {
                showError("Init Failed: " + e.message);
            }
        }

        init();

        // --- File Handling ---
        els.fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Reset State
            if(tonePlayer) {
                tonePlayer.stop();
                tonePlayer.dispose();
            }
            isPlaying = false;
            updatePlayButton();
            els.playBtn.disabled = true;
            els.downloadBtn.disabled = true;
            els.fileName.innerText = file.name;
            
            showLoader("Reading File...");

            try {
                // 1. Read File
                const arrayBuffer = await file.arrayBuffer();
                
                // 2. Decode Audio (Native Browser Decode)
                showLoader("Decoding Audio...");
                const audioCtx = Tone.getContext().rawContext;
                audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

                if(!audioBuffer) throw new Error("Decoding returned empty buffer");

                // 3. Load into Tone.Player
                showLoader("Building Audio Graph...");
                tonePlayer = new Tone.Player(audioBuffer);
                
                // Connect Chain: Player -> Pitch -> Reverb -> Bass -> EQ -> Limiter -> Out
                tonePlayer.disconnect();
                let current = tonePlayer;
                current.connect(pitchShift);
                pitchShift.connect(reverb);
                reverb.connect(bassBoost);
                
                let prev = bassBoost;
                eqNodes.forEach(node => {
                    prev.connect(node);
                    prev = node;
                });
                prev.connect(limiter);
                limiter.connect(Tone.Destination);

                // 4. Load into WaveSurfer (Visuals)
                // We mute wavesurfer because Tone.js handles the audio
                wavesurfer.loadDecodedBuffer(audioBuffer);
                wavesurfer.setVolume(0);

                wavesurfer.on('ready', () => {
                    hideLoader();
                    els.playBtn.disabled = false;
                    els.downloadBtn.disabled = false;
                    els.totalTime.innerText = " / " + formatTime(audioBuffer.duration);
                    log("File Ready.");
                });

                // 5. Sync Logic: Seeking
                wavesurfer.on('interaction', () => {
                    if(!tonePlayer.loaded) return;
                    const time = wavesurfer.getCurrentTime();
                    
                    // If playing, jump and keep playing
                    if(tonePlayer.state === "started") {
                        tonePlayer.seek(time);
                    } else {
                        // If paused, just update the start offset internally in Tone
                        // Tone.Player doesn't have a "cursor" property when stopped, 
                        // so we just handle it on the next Play click.
                    }
                });

            } catch (err) {
                console.error(err);
                showError("Error: " + err.message);
            }
        });

        // --- Playback Logic ---
        els.playBtn.addEventListener('click', async () => {
            await Tone.start(); // Ensure AudioContext is running

            if (isPlaying) {
                // Pause
                tonePlayer.stop();
                wavesurfer.pause();
                isPlaying = false;
                log("Paused");
            } else {
                // Play
                // Get start time from WaveSurfer cursor
                const startOffset = wavesurfer.getCurrentTime();
                
                // Start Tone (Audio)
                tonePlayer.start(undefined, startOffset);
                
                // Start WaveSurfer (Visuals)
                wavesurfer.play();
                
                isPlaying = true;
                log("Playing");
                
                // Start UI Loop
                requestAnimationFrame(uiLoop);
            }
            updatePlayButton();
        });

        function updatePlayButton() {
            if(isPlaying) {
                els.playIcon.classList.add('hidden');
                els.pauseIcon.classList.remove('hidden');
            } else {
                els.playIcon.classList.remove('hidden');
                els.pauseIcon.classList.add('hidden');
            }
        }

        function uiLoop() {
            if(!isPlaying) return;
            
            // Update Time Display
            const t = wavesurfer.getCurrentTime();
            els.currentTime.innerText = formatTime(t);

            // Check if finished
            if(t >= audioBuffer.duration) {
                isPlaying = false;
                updatePlayButton();
                tonePlayer.stop();
                wavesurfer.stop();
            } else {
                requestAnimationFrame(uiLoop);
            }
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        // --- Effects Controls ---
        
        // Helper to update slider UI and value
        function setControl(id, value) {
            const el = document.getElementById(id);
            if(el) {
                el.value = value;
                el.dispatchEvent(new Event('input'));
            }
        }

        document.getElementById('speedRange').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('speedVal').innerText = val.toFixed(2) + 'x';
            if(tonePlayer) tonePlayer.playbackRate = val;
            wavesurfer.setPlaybackRate(val); // Keep visuals synced
        });

        document.getElementById('pitchRange').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            document.getElementById('pitchVal').innerText = val + ' semi';
            pitchShift.pitch = val;
        });

        document.getElementById('reverbRange').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('reverbVal').innerText = Math.round(val * 100) + '%';
            reverb.wet.value = val;
        });

        document.getElementById('bassRange').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('bassVal').innerText = val + ' dB';
            bassBoost.gain.value = val;
        });

        // EQ Controls
        document.querySelectorAll('.eq-band').forEach(slider => {
            slider.addEventListener('input', (e) => {
                const idx = parseInt(e.target.dataset.idx);
                const val = parseFloat(e.target.value);
                if(eqNodes[idx]) eqNodes[idx].gain.value = val;
            });
        });

        window.resetEQ = function() {
            document.querySelectorAll('.eq-band').forEach(s => {
                s.value = 0;
                s.dispatchEvent(new Event('input'));
            });
        }

        window.applyPreset = function(type) {
            if(type === 'slowed') {
                setControl('speedRange', 0.85);
                setControl('pitchRange', -2);
                setControl('reverbRange', 0.3);
                setControl('bassRange', 6);
            } else if (type === 'nightcore') {
                setControl('speedRange', 1.25);
                setControl('pitchRange', 4);
                setControl('reverbRange', 0.1);
                setControl('bassRange', -2);
            }
        }

        document.getElementById('resetBtn').addEventListener('click', () => {
            setControl('speedRange', 1);
            setControl('pitchRange', 0);
            setControl('reverbRange', 0);
            setControl('bassRange', 0);
            resetEQ();
        });

        // --- Download Logic (Offline Rendering) ---
        els.downloadBtn.addEventListener('click', async () => {
            if(!audioBuffer) return;

            // Show Modal
            const modal = document.getElementById('dlModal');
            const bar = document.getElementById('dlBar');
            const txt = document.getElementById('dlPercent');
            modal.classList.remove('hidden');
            
            try {
                // Calculate Duration
                const rate = tonePlayer.playbackRate;
                const duration = (audioBuffer.duration / rate) + 3.0; // Add tail

                // Create Offline Context
                const offlineCtx = new Tone.OfflineContext(2, duration, audioBuffer.sampleRate);

                // Rebuild Graph Offline
                const offPlayer = new Tone.Player(audioBuffer);
                offPlayer.playbackRate = rate;

                const offPitch = new Tone.PitchShift({ pitch: pitchShift.pitch });
                const offReverb = new Tone.Reverb({ decay: 2.0, preDelay: 0.1 });
                await offReverb.ready;
                offReverb.wet.value = reverb.wet.value;

                const offBass = new Tone.Filter(200, "lowshelf");
                offBass.gain.value = bassBoost.gain.value;

                // Chain
                let current = offPlayer;
                current.connect(offPitch);
                offPitch.connect(offReverb);
                offReverb.connect(offBass);
                
                let prev = offBass;
                // Rebuild EQ
                eqFreqs.forEach((f, i) => {
                    const filter = new Tone.Filter(f, "peaking");
                    filter.Q.value = 1;
                    filter.gain.value = eqNodes[i].gain.value;
                    prev.connect(filter);
                    prev = filter;
                });

                const offLimiter = new Tone.Limiter(-1);
                prev.connect(offLimiter);
                offLimiter.connect(offlineCtx.destination);

                // Start
                offPlayer.start(0);

                // Fake Progress (since Tone doesn't provide granular progress)
                let p = 0;
                const interval = setInterval(() => {
                    p += 5;
                    if(p > 90) p = 90;
                    bar.style.width = p + "%";
                    txt.innerText = p + "%";
                }, 100);

                // Render
                const renderedBuffer = await offlineCtx.render();
                
                clearInterval(interval);
                bar.style.width = "100%";
                txt.innerText = "100%";

                // Encode & Download
                const wav = bufferToWave(renderedBuffer, renderedBuffer.length);
                const url = URL.createObjectURL(wav);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Remix_${Date.now()}.wav`;
                a.click();
                URL.revokeObjectURL(url);

                setTimeout(() => {
                    modal.classList.add('hidden');
                    bar.style.width = "0%";
                }, 1000);

            } catch (e) {
                modal.classList.add('hidden');
                showError("Render Failed: " + e.message);
            }
        });

        // WAV Encoder
        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels,
                length = len * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length),
                view = new DataView(buffer),
                channels = [], i, sample,
                offset = 0,
                pos = 0;

            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
            setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
            setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
            setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164);
            setUint32(length - pos - 4);

            for(i = 0; i < abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));

            while(pos < length) {
                for(i = 0; i < numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][offset]));
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767)|0;
                    view.setInt16(pos, sample, true);
                    pos += 2;
                }
                offset++;
            }
            return new Blob([buffer], {type: "audio/wav"});

            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
        }
    </script>
</body>
</html>
