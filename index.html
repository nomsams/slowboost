<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioRemix - Pro Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- WaveSurfer 7 (Stable) -->
    <script src="https://unpkg.com/wavesurfer.js@7.0.0/dist/wavesurfer.min.js"></script>
    <!-- Tone.js (Stable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        /* --- UI Styling --- */
        body { background-color: #05030a; color: white; }
        
        /* Sliders */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]:focus { outline: none; }
        
        /* Horizontal Slider */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px; width: 14px;
            border-radius: 50%;
            background: #d8b4fe; /* Purple-300 */
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 0 10px rgba(216, 180, 254, 0.6);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer;
            background: #4c1d95; /* Purple-900 */
            border-radius: 2px;
        }

        /* Vertical EQ Sliders */
        .slider-v {
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* WebKit */
            width: 8px; height: 110px;
            background: transparent; cursor: pointer;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f0720; }
        ::-webkit-scrollbar-thumb { background: #581c87; border-radius: 3px; }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #a855f7;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden font-sans selection:bg-purple-500 selection:text-white">

    <!-- Header -->
    <header class="h-16 border-b border-purple-900/30 flex items-center justify-between px-6 bg-[#0f0720] shrink-0 z-20">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 font-bold text-xl tracking-tight">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-600 to-fuchsia-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-900/50">
                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>
                </div>
                AudioRemix
            </div>
            
            <div class="h-8 w-[1px] bg-white/10"></div>

            <div class="flex items-center gap-4">
                <label class="cursor-pointer bg-purple-700 hover:bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center gap-2 shadow-lg shadow-purple-900/20">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Upload Audio
                    <input type="file" id="fileInput" accept="audio/*" class="hidden">
                </label>
                <div class="flex flex-col">
                    <span id="fileName" class="text-xs text-gray-300 font-mono max-w-[200px] truncate">No file selected</span>
                    <span id="statusText" class="text-[10px] text-gray-500">Waiting for input...</span>
                </div>
            </div>
        </div>

        <div class="flex gap-3">
            <button id="resetBtn" class="px-4 py-2 text-xs font-bold text-gray-400 hover:text-white border border-gray-800 rounded hover:bg-gray-800 transition">RESET</button>
            <button id="downloadBtn" class="bg-white text-black px-5 py-2 rounded text-xs font-bold hover:bg-gray-200 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                DOWNLOAD WAV
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left: Visualizer Area -->
        <div class="flex-1 flex flex-col bg-gradient-to-b from-[#0f0720] to-[#05030a] relative">
            
            <!-- Waveform -->
            <div class="flex-1 flex items-center justify-center px-6 relative group">
                <!-- The Waveform Container -->
                <div id="waveform" class="w-full h-48 opacity-80 transition-opacity hover:opacity-100"></div>
                
                <!-- Center Line -->
                <div class="absolute w-full h-[1px] bg-white/5 pointer-events-none"></div>

                <!-- Loading Overlay -->
                <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center bg-[#05030a]/90 z-10 hidden backdrop-blur-sm">
                    <div class="loader mb-4"></div>
                    <p id="loaderText" class="text-purple-300 font-mono text-sm">Loading Audio...</p>
                </div>
            </div>

            <!-- Player Controls -->
            <div class="h-24 bg-[#0a0514] border-t border-purple-900/20 flex items-center justify-between px-8 shrink-0">
                <div class="flex items-center gap-6">
                    <button id="playBtn" class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-black hover:scale-105 transition shadow-[0_0_20px_rgba(255,255,255,0.2)] disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg id="playIcon" class="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <div class="flex flex-col">
                        <span id="currentTime" class="text-2xl font-mono font-bold text-white">0:00</span>
                        <span id="totalTime" class="text-xs text-gray-500 font-mono">/ 0:00</span>
                    </div>
                </div>
                
                <!-- Debug Log -->
                <div id="debugLog" class="text-[10px] font-mono text-gray-600 max-w-md text-right hidden md:block">
                    System Ready.
                </div>
            </div>
        </div>

        <!-- Right: Controls Sidebar -->
        <div class="w-80 lg:w-96 bg-[#0a0514] border-l border-purple-900/20 flex flex-col overflow-y-auto custom-scrollbar shrink-0">
            
            <!-- Presets -->
            <div class="p-6 border-b border-white/5">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Quick Presets</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="applyPreset('slowed')" class="py-3 bg-purple-900/20 border border-purple-800/50 rounded-lg hover:bg-purple-800/40 text-xs text-purple-200 transition font-medium">Slowed + Reverb</button>
                    <button onclick="applyPreset('nightcore')" class="py-3 bg-purple-900/20 border border-purple-800/50 rounded-lg hover:bg-purple-800/40 text-xs text-purple-200 transition font-medium">Nightcore</button>
                </div>
            </div>

            <!-- Effects Sliders -->
            <div class="p-6 space-y-8">
                
                <!-- Speed -->
                <div>
                    <div class="flex justify-between mb-2 items-end">
                        <label class="text-xs font-medium text-gray-400">Speed</label>
                        <span id="speedVal" class="text-[10px] bg-purple-900/50 border border-purple-700/50 px-2 py-0.5 rounded text-purple-200 font-mono">1.00x</span>
                    </div>
                    <input type="range" id="speedRange" min="0.5" max="1.5" step="0.01" value="1">
                </div>

                <!-- Pitch -->
                <div>
                    <div class="flex justify-between mb-2 items-end">
                        <label class="text-xs font-medium text-gray-400">Pitch Shift</label>
                        <span id="pitchVal" class="text-[10px] bg-purple-900/50 border border-purple-700/50 px-2 py-0.5 rounded text-purple-200 font-mono">0 semi</span>
                    </div>
                    <input type="range" id="pitchRange" min="-12" max="12" step="1" value="0">
                </div>

                <!-- Reverb -->
                <div>
                    <div class="flex justify-between mb-2 items-end">
                        <label class="text-xs font-medium text-gray-400">Reverb</label>
                        <span id="reverbVal" class="text-[10px] bg-purple-900/50 border border-purple-700/50 px-2 py-0.5 rounded text-purple-200 font-mono">0%</span>
                    </div>
                    <input type="range" id="reverbRange" min="0" max="0.8" step="0.01" value="0">
                </div>

                <!-- Bass -->
                <div>
                    <div class="flex justify-between mb-2 items-end">
                        <label class="text-xs font-medium text-gray-400">Bass Boost</label>
                        <span id="bassVal" class="text-[10px] bg-purple-900/50 border border-purple-700/50 px-2 py-0.5 rounded text-purple-200 font-mono">0 dB</span>
                    </div>
                    <input type="range" id="bassRange" min="0" max="20" step="1" value="0">
                </div>
            </div>

            <!-- Graphic EQ -->
            <div class="flex-1 p-6 bg-[#080410] border-t border-white/5">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Graphic Equalizer</h3>
                    <button onclick="resetEQ()" class="text-[10px] text-purple-400 hover:text-white underline decoration-purple-500/30">Flat</button>
                </div>
                <div class="flex justify-between h-32 items-end px-1">
                    <!-- EQ Bands -->
                    <div class="flex flex-col items-center gap-2 h-full"><input type="range" class="slider-v eq-band" data-idx="0" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">60</span></div>
                    <div class="flex flex-col items-center gap-2 h-full"><input type="range" class="slider-v eq-band" data-idx="1" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">150</span></div>
                    <div class="flex flex-col items-center gap-2 h-full"><input type="range" class="slider-v eq-band" data-idx="2" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">400</span></div>
                    <div class="flex flex-col items-center gap-2 h-full"><input type="range" class="slider-v eq-band" data-idx="3" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">1k</span></div>
                    <div class="flex flex-col items-center gap-2 h-full"><input type="range" class="slider-v eq-band" data-idx="4" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">2.5k</span></div>
                    <div class="flex flex-col items-center gap-2 h-full"><input type="range" class="slider-v eq-band" data-idx="5" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">6k</span></div>
                    <div class="flex flex-col items-center gap-2 h-full"><input type="range" class="slider-v eq-band" data-idx="6" min="-12" max="12" value="0"><span class="text-[9px] text-gray-600">14k</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Modal -->
    <div id="dlModal" class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col items-center justify-center backdrop-blur-md">
        <div class="w-72">
            <div class="flex justify-between text-xs text-purple-300 mb-2 font-mono">
                <span>RENDERING AUDIO</span>
                <span id="dlPercent">0%</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2 overflow-hidden">
                <div id="dlBar" class="bg-gradient-to-r from-purple-600 to-pink-500 h-2 rounded-full transition-all duration-100" style="width: 0%"></div>
            </div>
        </div>
        <p class="text-gray-500 text-xs mt-4 animate-pulse">Applying high-quality effects...</p>
    </div>

    <script>
        // --- Configuration ---
        const EQ_FREQS = [60, 150, 400, 1000, 2500, 6000, 14000];
        
        // --- State ---
        let wavesurfer, tonePlayer;
        let isPlaying = false;
        let audioBlobUrl = null;
        let audioBuffer = null; // For offline rendering
        
        // Effects
        let pitchShift, reverb, bassBoost, limiter;
        let eqNodes = [];

        // --- DOM ---
        const els = {
            fileInput: document.getElementById('fileInput'),
            playBtn: document.getElementById('playBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            fileName: document.getElementById('fileName'),
            status: document.getElementById('statusText'),
            debug: document.getElementById('debugLog'),
            loader: document.getElementById('loader'),
            loaderText: document.getElementById('loaderText'),
            playIcon: document.getElementById('playIcon'),
            pauseIcon: document.getElementById('pauseIcon'),
            currentTime: document.getElementById('currentTime'),
            totalTime: document.getElementById('totalTime')
        };

        // --- Logging ---
        function log(msg, isError = false) {
            els.debug.innerText = `> ${msg}`;
            els.status.innerText = msg;
            if (isError) {
                els.debug.style.color = '#f87171';
                console.error(msg);
            } else {
                els.debug.style.color = '#9ca3af';
            }
        }

        function showLoader(msg) {
            els.loader.classList.remove('hidden');
            els.loaderText.innerText = msg;
        }

        function hideLoader() {
            els.loader.classList.add('hidden');
        }

        // --- Initialization ---
        async function init() {
            // 1. WaveSurfer (Visuals)
            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#4c1d95',
                progressColor: '#a855f7',
                cursorColor: '#ffffff',
                barWidth: 2,
                barGap: 3,
                barRadius: 2,
                height: 192,
                normalize: true,
                interact: true,
                fillParent: true, // SoundCloud style
                minPxPerSec: 20   // Zoomed out view
            });

            // 2. Tone.js Effects Chain
            pitchShift = new Tone.PitchShift({ pitch: 0 }).toDestination();
            reverb = new Tone.Reverb({ decay: 2.5, preDelay: 0.1 }).toDestination();
            reverb.wet.value = 0;
            bassBoost = new Tone.Filter(200, "lowshelf").toDestination();
            limiter = new Tone.Limiter(-1).toDestination();

            // EQ
            eqNodes = EQ_FREQS.map(f => {
                const filter = new Tone.Filter(f, "peaking");
                filter.Q.value = 1;
                filter.gain.value = 0;
                return filter;
            });
        }
        init();

        // --- File Loading (Robust Method) ---
        els.fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Cleanup
            if (audioBlobUrl) URL.revokeObjectURL(audioBlobUrl);
            if (tonePlayer) { tonePlayer.dispose(); }
            
            // Reset UI
            isPlaying = false;
            updatePlayBtn();
            els.playBtn.disabled = true;
            els.downloadBtn.disabled = true;
            els.fileName.innerText = file.name;
            
            showLoader("Loading Audio File...");
            log("Starting load sequence...");

            try {
                // 1. Create Blob URL (Instant, no memory crash)
                audioBlobUrl = URL.createObjectURL(file);

                // 2. Load WaveSurfer (Visuals)
                // We use the URL method which is safer for large files in WS v7
                await wavesurfer.load(audioBlobUrl);
                wavesurfer.setVolume(0); // Mute visuals, Tone handles audio

                // 3. Load Tone.Player (Audio)
                // We also use the URL method. Tone handles the XHR/Decoding internally.
                tonePlayer = new Tone.Player(audioBlobUrl, () => {
                    log("Tone.Player loaded.");
                    
                    // Connect Chain
                    tonePlayer.disconnect();
                    let current = tonePlayer;
                    current.connect(pitchShift);
                    pitchShift.connect(reverb);
                    reverb.connect(bassBoost);
                    
                    let prev = bassBoost;
                    eqNodes.forEach(n => { prev.connect(n); prev = n; });
                    prev.connect(limiter);
                    limiter.connect(Tone.Destination);

                    // Ready
                    hideLoader();
                    els.playBtn.disabled = false;
                    els.downloadBtn.disabled = false;
                    els.totalTime.innerText = "/ " + formatTime(tonePlayer.buffer.duration);
                    
                    // Store buffer for offline rendering later
                    audioBuffer = tonePlayer.buffer; 
                    
                    log("Ready to play.");
                }).toDestination();

            } catch (err) {
                hideLoader();
                log("Load Error: " + err.message, true);
                alert("Could not load file. It might be corrupt or format unsupported.\nError: " + err.message);
            }
        });

        // --- Sync & Playback ---
        
        // Sync WaveSurfer Seek -> Tone.Player
        wavesurfer.on('interaction', () => {
            if(!tonePlayer || !tonePlayer.loaded) return;
            const t = wavesurfer.getCurrentTime();
            
            if(tonePlayer.state === "started") {
                // Tone.Player.seek() expects offset in seconds
                tonePlayer.seek(t);
            }
        });

        els.playBtn.addEventListener('click', async () => {
            await Tone.start(); // Required for browser audio policy

            if (isPlaying) {
                tonePlayer.stop();
                wavesurfer.pause();
                isPlaying = false;
                log("Paused");
            } else {
                const t = wavesurfer.getCurrentTime();
                tonePlayer.start(undefined, t);
                wavesurfer.play();
                isPlaying = true;
                log("Playing");
                requestAnimationFrame(uiLoop);
            }
            updatePlayBtn();
        });

        function updatePlayBtn() {
            if(isPlaying) {
                els.playIcon.classList.add('hidden');
                els.pauseIcon.classList.remove('hidden');
            } else {
                els.playIcon.classList.remove('hidden');
                els.pauseIcon.classList.add('hidden');
            }
        }

        function uiLoop() {
            if(!isPlaying) return;
            
            // Update Timer
            const t = wavesurfer.getCurrentTime();
            els.currentTime.innerText = formatTime(t);

            // Check End
            if(t >= wavesurfer.getDuration() - 0.1) {
                isPlaying = false;
                updatePlayBtn();
                tonePlayer.stop();
                wavesurfer.stop();
            } else {
                requestAnimationFrame(uiLoop);
            }
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        // --- Effects Logic ---
        
        function setVal(id, val) {
            const el = document.getElementById(id);
            if(el) { el.value = val; el.dispatchEvent(new Event('input')); }
        }

        // Speed
        document.getElementById('speedRange').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('speedVal').innerText = val.toFixed(2) + 'x';
            if(tonePlayer) tonePlayer.playbackRate = val;
            wavesurfer.setPlaybackRate(val);
        });

        // Pitch
        document.getElementById('pitchRange').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            document.getElementById('pitchVal').innerText = val + ' semi';
            pitchShift.pitch = val;
        });

        // Reverb
        document.getElementById('reverbRange').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('reverbVal').innerText = Math.round(val * 100) + '%';
            reverb.wet.value = val;
        });

        // Bass
        document.getElementById('bassRange').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('bassVal').innerText = val + ' dB';
            bassBoost.gain.value = val;
        });

        // EQ
        document.querySelectorAll('.eq-band').forEach(slider => {
            slider.addEventListener('input', (e) => {
                const idx = parseInt(e.target.dataset.idx);
                const val = parseFloat(e.target.value);
                if(eqNodes[idx]) eqNodes[idx].gain.value = val;
            });
        });

        window.resetEQ = () => {
            document.querySelectorAll('.eq-band').forEach(s => { s.value = 0; s.dispatchEvent(new Event('input')); });
        };

        window.applyPreset = (type) => {
            if(type === 'slowed') {
                setVal('speedRange', 0.85);
                setVal('pitchRange', -2);
                setVal('reverbRange', 0.35);
                setVal('bassRange', 6);
            } else if (type === 'nightcore') {
                setVal('speedRange', 1.25);
                setVal('pitchRange', 4);
                setVal('reverbRange', 0.1);
                setVal('bassRange', -2);
            }
        };

        document.getElementById('resetBtn').addEventListener('click', () => {
            setVal('speedRange', 1);
            setVal('pitchRange', 0);
            setVal('reverbRange', 0);
            setVal('bassRange', 0);
            resetEQ();
        });

        // --- Download (Offline Render) ---
        els.downloadBtn.addEventListener('click', async () => {
            if(!audioBuffer) return;

            const modal = document.getElementById('dlModal');
            const bar = document.getElementById('dlBar');
            const txt = document.getElementById('dlPercent');
            modal.classList.remove('hidden');

            try {
                // 1. Setup Offline Context
                const rate = tonePlayer.playbackRate;
                const duration = (audioBuffer.duration / rate) + 3.0; // +3s tail
                const offlineCtx = new Tone.OfflineContext(2, duration, audioBuffer.sampleRate);

                // 2. Rebuild Graph
                const offPlayer = new Tone.Player(audioBuffer);
                offPlayer.playbackRate = rate;

                const offPitch = new Tone.PitchShift({ pitch: pitchShift.pitch });
                const offReverb = new Tone.Reverb({ decay: 2.5, preDelay: 0.1 });
                await offReverb.ready;
                offReverb.wet.value = reverb.wet.value;

                const offBass = new Tone.Filter(200, "lowshelf");
                offBass.gain.value = bassBoost.gain.value;

                // Chain
                let current = offPlayer;
                current.connect(offPitch);
                offPitch.connect(offReverb);
                offReverb.connect(offBass);
                
                let prev = offBass;
                EQ_FREQS.forEach((f, i) => {
                    const filter = new Tone.Filter(f, "peaking");
                    filter.Q.value = 1;
                    filter.gain.value = eqNodes[i].gain.value;
                    prev.connect(filter);
                    prev = filter;
                });

                const offLimiter = new Tone.Limiter(-1);
                prev.connect(offLimiter);
                offLimiter.connect(offlineCtx.destination);

                offPlayer.start(0);

                // 3. Render
                // Fake progress bar since Tone doesn't emit progress events
                let p = 0;
                const timer = setInterval(() => {
                    p += 2; if(p>95) p=95;
                    bar.style.width = p + "%";
                    txt.innerText = p + "%";
                }, 100);

                const renderedBuffer = await offlineCtx.render();
                clearInterval(timer);
                
                bar.style.width = "100%";
                txt.innerText = "100%";

                // 4. Encode & Download
                const wav = bufferToWave(renderedBuffer, renderedBuffer.length);
                const url = URL.createObjectURL(wav);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Remix_${Date.now()}.wav`;
                a.click();
                URL.revokeObjectURL(url);

                setTimeout(() => {
                    modal.classList.add('hidden');
                    bar.style.width = "0%";
                }, 1000);

            } catch (err) {
                modal.classList.add('hidden');
                alert("Render Failed: " + err.message);
            }
        });

        // WAV Encoder
        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels,
                length = len * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length),
                view = new DataView(buffer),
                channels = [], i, sample,
                offset = 0,
                pos = 0;

            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
            setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
            setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
            setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164);
            setUint32(length - pos - 4);

            for(i = 0; i < abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));

            while(pos < length) {
                for(i = 0; i < numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][offset]));
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767)|0;
                    view.setInt16(pos, sample, true);
                    pos += 2;
                }
                offset++;
            }
            return new Blob([buffer], {type: "audio/wav"});

            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
        }
    </script>
</body>
</html>
